# Fluent Bit configuration for Agentic Startup Studio
# Collects, processes, and forwards logs from all services

[SERVICE]
    Flush           5
    Daemon          off
    Log_Level       info
    Parsers_File    parsers.conf
    HTTP_Server     On
    HTTP_Listen     0.0.0.0
    HTTP_Port       2020
    Health_Check    On
    storage.path    /tmp/flb-storage/
    storage.sync    normal
    storage.checksum off
    storage.backlog.mem_limit 50M

# =============================================================================
# INPUT PLUGINS
# =============================================================================

# Application logs from containers
[INPUT]
    Name              tail
    Tag               app.*
    Path              /var/log/containers/*app*.log
    Parser            docker
    DB                /tmp/flb_app.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10

# Nginx access logs
[INPUT]
    Name              tail
    Tag               nginx.access
    Path              /var/log/nginx/access.log
    Parser            nginx
    DB                /tmp/flb_nginx_access.db
    Mem_Buf_Limit     20MB

# Nginx error logs
[INPUT]
    Name              tail
    Tag               nginx.error
    Path              /var/log/nginx/error.log
    Parser            nginx_error
    DB                /tmp/flb_nginx_error.db
    Mem_Buf_Limit     20MB

# PostgreSQL logs
[INPUT]
    Name              tail
    Tag               postgres.*
    Path              /var/log/postgresql/*.log
    Parser            postgres
    DB                /tmp/flb_postgres.db
    Mem_Buf_Limit     30MB

# Redis logs
[INPUT]
    Name              tail
    Tag               redis.*
    Path              /var/log/redis/*.log
    Parser            redis
    DB                /tmp/flb_redis.db
    Mem_Buf_Limit     10MB

# System logs
[INPUT]
    Name              systemd
    Tag               systemd.*
    Systemd_Filter    _SYSTEMD_UNIT=docker.service
    Systemd_Filter    _SYSTEMD_UNIT=nginx.service
    Read_From_Tail    On

# Docker container logs
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    Tag               docker.*

# Custom application metrics logs
[INPUT]
    Name              tail
    Tag               metrics.*
    Path              /var/log/app/metrics/*.log
    Parser            json
    DB                /tmp/flb_metrics.db
    Mem_Buf_Limit     30MB

# AI/ML model logs
[INPUT]
    Name              tail
    Tag               ai.models
    Path              /var/log/app/models/*.log
    Parser            json
    DB                /tmp/flb_models.db
    Mem_Buf_Limit     50MB

# CrewAI agent logs
[INPUT]
    Name              tail
    Tag               ai.agents
    Path              /var/log/app/agents/*.log
    Parser            json
    DB                /tmp/flb_agents.db
    Mem_Buf_Limit     100MB

# Security audit logs
[INPUT]
    Name              tail
    Tag               security.audit
    Path              /var/log/app/security/*.log
    Parser            json
    DB                /tmp/flb_security.db
    Mem_Buf_Limit     50MB

# =============================================================================
# FILTER PLUGINS
# =============================================================================

# Add hostname and service metadata
[FILTER]
    Name              record_modifier
    Match             *
    Record            hostname ${HOSTNAME}
    Record            service_name agentic-startup-studio
    Record            environment ${ENVIRONMENT}
    Record            version ${APP_VERSION}

# Parse JSON logs from application
[FILTER]
    Name              parser
    Match             app.*
    Key_Name          log
    Parser            json
    Reserve_Data      On
    Preserve_Key      On

# Add log level classification for AI agent logs
[FILTER]
    Name              grep
    Match             ai.agents
    Regex             level (ERROR|CRITICAL|FATAL)
    Tag               ai.agents.critical

# Extract and enrich AI model performance data
[FILTER]
    Name              record_modifier
    Match             ai.models
    Record            component ai_model
    Record            subsystem inference

# Security log enrichment
[FILTER]
    Name              lua
    Match             security.*
    Script            security_enrichment.lua
    Call              enrich_security_logs

# Rate limiting filter for high-volume logs
[FILTER]
    Name              throttle
    Match             nginx.access
    Rate              1000
    Window            300
    Interval          1s

# Remove sensitive data from logs
[FILTER]
    Name              modify
    Match             *
    Remove            password
    Remove            token
    Remove            api_key
    Remove            secret
    Remove            authorization

# Add geographic data for IP addresses
[FILTER]
    Name              geoip2
    Match             nginx.access
    Database          /etc/fluent-bit/GeoLite2-City.mmdb
    Lookup_key        remote_addr
    Record            geoip2.country_code %{geoip2.country.iso_code}
    Record            geoip2.country_name %{geoip2.country.names.en}
    Record            geoip2.city_name %{geoip2.city.names.en}

# =============================================================================
# OUTPUT PLUGINS
# =============================================================================

# Forward to Elasticsearch for indexing and search
[OUTPUT]
    Name              es
    Match             *
    Host              elasticsearch
    Port              9200
    Index             agentic-startup-logs
    Type              _doc
    HTTP_User         elastic
    HTTP_Passwd       ${ELASTICSEARCH_PASSWORD}
    Logstash_Format   On
    Logstash_Prefix   agentic-startup
    Logstash_DateFormat %Y.%m.%d
    Include_Tag_Key   On
    Tag_Key           @tag
    Retry_Limit       5
    Buffer_Size       5MB
    tls               On
    tls.verify        Off

# Forward critical logs to alerting system
[OUTPUT]
    Name              http
    Match             *.critical
    Host              alertmanager
    Port              9093
    URI               /api/v1/alerts
    Format            json
    Header            Content-Type application/json
    Retry_Limit       3

# Forward security logs to SIEM
[OUTPUT]
    Name              forward
    Match             security.*
    Host              siem-collector
    Port              24224
    Retry_Limit       5
    tls               On
    tls.verify        Off

# Store AI/ML logs in specialized storage
[OUTPUT]
    Name              s3
    Match             ai.*
    Bucket            agentic-startup-ai-logs
    Region            us-east-1
    S3_key_format     /ai-logs/%Y/%m/%d/ai-logs-%H%M%S-$UUID.json
    Total_file_size   50M
    Upload_timeout    10m
    Use_put_object    On

# Forward metrics logs to Prometheus pushgateway
[OUTPUT]
    Name              http
    Match             metrics.*
    Host              pushgateway
    Port              9091
    URI               /metrics/job/fluent-bit
    Format            prometheus
    Retry_Limit       3

# Debug output for development
[OUTPUT]
    Name              stdout
    Match             app.debug
    Format            json_lines